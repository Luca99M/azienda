<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonno Andrea - Distributore Intelligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at center, #2c5f2d, #1a3d1b);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }
        
        .container {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 480px;
            width: 100%;
            height: 720px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .character-section {
            background: linear-gradient(135deg, #87ceeb 0%, #98fb98 50%, #f0e68c 100%);
            position: relative;
            height: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        /* Particelle fluttuanti */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            animation: float-particle 8s infinite linear;
        }
        
        .particle:nth-child(1) { width: 4px; height: 4px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 6px; height: 6px; left: 20%; animation-delay: 1s; }
        .particle:nth-child(3) { width: 3px; height: 3px; left: 30%; animation-delay: 2s; }
        .particle:nth-child(4) { width: 5px; height: 5px; left: 40%; animation-delay: 3s; }
        .particle:nth-child(5) { width: 4px; height: 4px; left: 50%; animation-delay: 4s; }
        .particle:nth-child(6) { width: 6px; height: 6px; left: 60%; animation-delay: 5s; }
        .particle:nth-child(7) { width: 3px; height: 3px; left: 70%; animation-delay: 6s; }
        .particle:nth-child(8) { width: 5px; height: 5px; left: 80%; animation-delay: 7s; }
        
        @keyframes float-particle {
            0% { 
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Personaggio 3D */
        .character-3d {
            width: 250px;
            height: 320px;
            position: relative;
            z-index: 10;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 5;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            animation: pulse 1.5s infinite;
        }
        
        .loading-text.hidden {
            display: none;
        }
        
        .character-name {
            color: #2c5f2d;
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            position: relative;
        }
        
        .subtitle {
            color: #228b22;
            font-size: 16px;
            text-align: center;
            z-index: 10;
            position: relative;
            font-style: italic;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            max-height: 150px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message {
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            animation: slideIn 0.4s ease;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .bot-message {
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 8px;
            position: relative;
        }
        
        .bot-message::before {
            content: '👴';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }
        
        .user-message {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 8px;
        }
        
        .typing-indicator {
            display: none;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #6c757d;
            padding: 12px 16px;
            border-radius: 18px;
            margin-right: auto;
            max-width: 85%;
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .typing-dots span {
            animation: typing 1.4s infinite;
            animation-fill-mode: both;
            font-size: 18px;
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        .voice-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .mic-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
            position: relative;
        }
        
        .mic-button::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: linear-gradient(45deg, #ff6b6b, #ffa726) border-box;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            animation: rotate-border 3s linear infinite;
        }
        
        @keyframes rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(220,53,69,0.6);
        }
        
        .mic-button.listening {
            background: linear-gradient(135deg, #28a745, #20c997);
            animation: pulse-mic 1.2s infinite;
            box-shadow: 0 6px 20px rgba(40,167,69,0.5);
        }
        
        @keyframes pulse-mic {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(40, 167, 69, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        .listening-indicator {
            display: none;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            animation: pulse-text 1s infinite;
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        
        .listening-indicator.active {
            display: block;
        }
        
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .volume-slider {
            width: 80px;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        
        .input-area {
            display: flex;
            gap: 12px;
        }
        
        .input-area input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #28a745;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-area input:focus {
            border-color: #20c997;
            box-shadow: 0 0 0 4px rgba(40,167,69,0.1);
            transform: scale(1.02);
        }
        
        .input-area button {
            padding: 16px 28px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(40,167,69,0.3);
        }
        
        .input-area button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40,167,69,0.4);
        }
        
        .voice-status {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(108,117,125,0.1);
            border-radius: 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                height: 90vh;
                max-width: 100%;
                border-radius: 15px;
            }
            
            .character-section {
                height: 350px;
            }
            
            .character-3d {
                width: 200px;
                height: 250px;
            }
            
            .character-name {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="character-section">
            <!-- Particelle fluttuanti -->
            <div class="particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            
            <!-- Personaggio 3D -->
            <div id="character3d" class="character-3d"></div>
            <div class="loading-text" id="loadingText">Caricamento nonno Andrea...</div>
            
            <div class="character-name">Nonno Andrea</div>
            <div class="subtitle">🌾 Agricoltore da 50 anni</div>
        </div>
        
        <div class="chat-section">
            <div class="messages" id="messages">
                <div class="message bot-message">
                    👋 Ciao! Sono nonno Andrea, ti va di sentire della mia azienda?
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Nonno Andrea sta pensando<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>
            
            <div class="voice-status" id="voiceStatus">
                🎤 Parla con nonno Andrea cliccando il microfono
            </div>
            
            <div class="voice-controls">
                <button class="mic-button" id="micButton" onclick="toggleListening()" title="Clicca per parlare">🎤</button>
                <div class="listening-indicator" id="listeningIndicator">🎤 Ti sto ascoltando...</div>
                <div class="volume-control">
                    🔊 <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="85" onchange="updateVolume()">
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="userInput" placeholder="Scrivi a nonno Andrea..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">💬</button>
            </div>
        </div>
    </div>

    <!-- Three.js per personaggio 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        let isTalking = false;
        let isListening = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let currentVoice = null;

        // Three.js variables per personaggio 3D
        let scene, camera, renderer, character3D, mixer, clock;
        let mouthBones = [];
        let isCharacterLoaded = false;

        // Setup Three.js e caricamento personaggio 3D
        function init3DCharacter() {
            const container = document.getElementById('character3d');
            const loadingText = document.getElementById('loadingText');
            
            // Setup scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Azzurro cielo
            
            camera = new THREE.PerspectiveCamera(75, 250/320, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ 
                alpha: true, 
                antialias: true 
            });
            renderer.setSize(250, 320);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            clock = new THREE.Clock();

            // Luci migliorate
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); // Luce ambiente più forte
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(2, 3, 1);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
            
            // Luce di riempimento
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
            fillLight.position.set(-1, 1, -1);
            scene.add(fillLight);

            // Carica il personaggio
            const loader = new THREE.GLTFLoader();
            const characterPath = './character.glb';
            
            loadingText.textContent = 'Caricamento nonno Andrea...';
            
            loader.load(
                characterPath,
                function(gltf) {
                    character3D = gltf.scene;
                    
                    // Calcola dimensioni automaticamente
                    const box = new THREE.Box3().setFromObject(character3D);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());
                    
                    console.log('Dimensioni originali:', size);
                    console.log('Centro:', center);
                    
                    // Scala automatica per adattare al container
                    const maxDimension = Math.max(size.x, size.y, size.z);
                    const targetSize = 1.5; // Dimensione target
                    const scale = targetSize / maxDimension;
                    
                    character3D.scale.setScalar(scale);
                    console.log('Scala applicata:', scale);
                    
                    // Centra il personaggio
                    character3D.position.x = -center.x * scale;
                    character3D.position.y = -center.y * scale;
                    character3D.position.z = -center.z * scale;
                    
                    // Posiziona per essere ben visibile (testa in alto)
                    character3D.position.y += size.y * scale * 0.1; // Alza leggermente
                    character3D.position.y -= 0.5; // Più in basso
                    
                    scene.add(character3D);
                    
                    // Setup animazioni
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(character3D);
                        
                        // Trova animazione idle
                        const idleAnim = gltf.animations.find(anim => 
                            anim.name.toLowerCase().includes('idle') ||
                            anim.name.toLowerCase().includes('breathing') ||
                            anim.name.toLowerCase().includes('stand')
                        ) || gltf.animations[0];
                        
                        if (idleAnim) {
                            const action = mixer.clipAction(idleAnim);
                            action.play();
                            console.log('Animazione caricata:', idleAnim.name);
                        }
                    }
                    
                    // Trova bones per lip sync
                    character3D.traverse(function(child) {
                        if (child.isBone) {
                            if (child.name.toLowerCase().includes('jaw') ||
                                child.name.toLowerCase().includes('mouth') ||
                                child.name.toLowerCase().includes('chin')) {
                                mouthBones.push(child);
                                console.log('Bone trovato per lip sync:', child.name);
                            }
                        }
                        
                        // Trova mesh con morph targets
                        if (child.isMesh && child.morphTargetInfluences) {
                            character3D.faceMesh = child;
                            console.log('Morph targets trovati:', child.morphTargetInfluences.length);
                        }
                        
                        // Migliora materiali
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            if (child.material) {
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    // Posiziona camera per inquadrare bene il personaggio
                    const distance = Math.max(size.x, size.y, size.z) * scale * 1.2;
                    camera.position.set(0, size.y * scale * 0.3, distance);
                    camera.lookAt(character3D.position);
                    
                    isCharacterLoaded = true;
                    loadingText.classList.add('hidden');
                    
                    console.log('✅ Personaggio 3D caricato con successo!');
                    console.log('Posizione finale:', character3D.position);
                    console.log('Scala finale:', character3D.scale);
                },
                function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    loadingText.textContent = `Caricamento... ${percent}%`;
                },
                function(error) {
                    console.error('❌ Errore caricamento personaggio:', error);
                    loadingText.textContent = '❌ Errore caricamento. Controlla che character.glb sia nella stessa cartella!';
                    loadingText.style.color = '#ff4444';
                    
                    // Fallback - carica un cubo di test
                    const geometry = new THREE.BoxGeometry(0.5, 1, 0.3);
                    const material = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
                    const testCube = new THREE.Mesh(geometry, material);
                    testCube.position.y = 0;
                    scene.add(testCube);
                    
                    camera.position.set(0, 0, 2);
                    camera.lookAt(0, 0, 0);
                    
                    setTimeout(() => {
                        loadingText.textContent = '🤖 Modalità test - personaggio generico';
                        loadingText.style.color = '#ffa500';
                        loadingText.classList.remove('hidden');
                    }, 1000);
                }
            );
            
            // Loop di rendering
            animate3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            
            if (mixer && isCharacterLoaded) {
                mixer.update(clock.getDelta());
            }
            
            // Rotazione leggera del personaggio
            if (character3D && isCharacterLoaded) {
                character3D.rotation.y = Math.sin(clock.getElapsedTime() * 0.3) * 0.1;
            }
            
            renderer.render(scene, camera);
        }

        // Controlli debug (opzionali - per testare)
        function addDebugControls() {
            // Aggiungi controlli mouse per ruotare la vista (opzionale)
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            const container = document.getElementById('character3d');
            
            container.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            container.addEventListener('mouseup', () => {
                mouseDown = false;
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!mouseDown || !character3D) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                character3D.rotation.y += deltaX * 0.01;
                character3D.rotation.x += deltaY * 0.01;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            // Zoom con rotella mouse
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.001;
                camera.position.z = Math.max(0.5, Math.min(camera.position.z, 10));
            });
        }

        // Risposte di nonno Andrea (più ricche e coinvolgenti)
        const responses = {
            'azienda': "🌾 Sai, la mia famiglia coltiva questa terra da tre generazioni! Io ho iniziato quando avevo 15 anni, aiutando mio papà con le olive. Ora ho 70 anni e ancora mi alzo all'alba per prendermi cura delle mie olive e delle mie pecorelle. Questa terra è la mia vita!",
            
            'olio': "🫒 Ah, il mio olio extravergine! Senti, le olive le raccolgo ancora a mano, una per una, come faceva mio nonno 100 anni fa. Le porto al frantoio entro 4 ore dalla raccolta. Il sapore? È come mordere un'oliva fresca appena colta! Piccante quanto basta per farti capire che è vero olio di qualità.",
            
            'pecore': "🐑 Le mie pecore sono la mia gioia! Le conosco tutte per nome: c'è Bianchina, Stella, Nocciola... Pascolano libere sui colli e il loro latte diventa il formaggio più buono che tu abbia mai assaggiato. Sono come le mie nipotine, eh!",
            
            'terra': "🌍 Questa terra è sacra per me. Non uso mai pesticidi o prodotti chimici, solo tanto amore, pazienza e il concime delle mie pecore. La terra ti dà quello che le dai tu. Se la rispetti, lei ti rispetta. I miei prodotti sanno di una volta perché li faccio esattamente come una volta.",
            
            'famiglia': "👨‍👩‍👧‍👦 La mia famiglia... mia moglie Maria mi aiuta ancora a 65 anni! È lei che fa il formaggio più buono della zona. I miei figli ora lavorano in città, ma nei weekend vengono sempre ad aiutarmi con la raccolta. Spero tanto che i nipotini continueranno questa tradizione!",
            
            'passione': "❤️ Sai cosa mi dà più gioia? Quando qualcuno assaggia i miei prodotti e vedo i suoi occhi che si illuminano. Quello è il momento magico in cui capisci che tutto il sudore, tutta la fatica, ne è valsa davvero la pena. È pura emozione!",
            
            'ricette': "👵 Mia nonna mi diceva sempre: 'Andrea, l'olio buono si riconosce sul pane tostato caldo'. E aveva proprio ragione! Oppure il cacio fresco con un filo del mio miele... Madonna mia che bontà! Ti viene l'acquolina solo a pensarci!",
            
            'stagioni': "🌤️ Ogni stagione qui ha la sua magia speciale. In primavera tutto fiorisce ed è un tripudio di colori, d'estate raccolgo il grano dorato, in autunno le olive mature, d'inverno riposo ma programmo l'anno nuovo. La natura è la mia sveglia e il mio calendario!",
            
            'difficolta': "😅 Non è sempre stato facile, eh! Quando viene la grandine improvvisa o la siccità dura mesi, piangi come un bambino. Ma poi vedi un piccolo germoglio nuovo che spunta dalla terra e ricominci con speranza. L'agricoltore è come il sole: cade la sera ma sa che domani sorgerà di nuovo!",
            
            'sogni': "✨ Il mio sogno più grande? Che i giovani di oggi riscoprano la bellezza della campagna. Che capiscano che qui c'è il vero futuro, non solo nelle città piene di smog. La terra ha bisogno di mani giovani e cuori appassionati come il mio!"
        };

        // Inizializza il riconoscimento vocale
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'it-IT';
                
                recognition.onstart = function() {
                    isListening = true;
                    updateListeningUI(true);
                    updateVoiceStatus("🎤 Dimmi tutto, ti ascolto con attenzione...");
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userInput').value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = function(event) {
                    updateVoiceStatus("😅 Non ho sentito bene, riprova o scrivimi!");
                    updateListeningUI(false);
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateListeningUI(false);
                    updateVoiceStatus("🎤 Parla con nonno Andrea cliccando il microfono");
                };
            } else {
                updateVoiceStatus("⚠️ Il microfono non funziona su questo browser");
            }
        }

        // Inizializza le voci
        function initVoices() {
            const voices = speechSynthesis.getVoices();
            currentVoice = voices.find(voice => voice.lang === 'it-IT') || 
                          voices.find(voice => voice.lang.startsWith('it')) || 
                          voices[0];
        }

        function updateListeningUI(listening) {
            const micButton = document.getElementById('micButton');
            const indicator = document.getElementById('listeningIndicator');
            
            if (listening) {
                micButton.classList.add('listening');
                micButton.innerHTML = '🔴';
                indicator.classList.add('active');
            } else {
                micButton.classList.remove('listening');
                micButton.innerHTML = '🎤';
                indicator.classList.remove('active');
            }
        }

        function updateVoiceStatus(message) {
            document.getElementById('voiceStatus').textContent = message;
        }

        function toggleListening() {
            if (!recognition) {
                updateVoiceStatus("❌ Microfono non disponibile");
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function updateVolume() {
            // Il volume verrà applicato quando parla
        }

        function makeCharacterTalk(duration = 3000) {
            if (isTalking || !isCharacterLoaded) return;
            
            isTalking = true;
            
            // Animazione lip sync per personaggio 3D
            if (character3D) {
                // Metodo 1: Morph targets (se disponibili)
                if (character3D.faceMesh && character3D.faceMesh.morphTargetInfluences) {
                    const morphs = character3D.faceMesh.morphTargetInfluences;
                    
                    const talkInterval = setInterval(() => {
                        // Simula movimento bocca
                        for (let i = 0; i < morphs.length; i++) {
                            if (i < 3) { // Prime 3 morph targets per bocca
                                morphs[i] = Math.random() * 0.8;
                            }
                        }
                    }, 150);
                    
                    setTimeout(() => {
                        clearInterval(talkInterval);
                        // Reset morph targets
                        for (let i = 0; i < morphs.length; i++) {
                            morphs[i] = 0;
                        }
                        isTalking = false;
                    }, duration);
                }
                
                // Metodo 2: Movimento bones mascella
                else if (mouthBones.length > 0) {
                    const originalRotations = mouthBones.map(bone => bone.rotation.x);
                    
                    const talkInterval = setInterval(() => {
                        mouthBones.forEach((bone, index) => {
                            bone.rotation.x = originalRotations[index] + Math.sin(Date.now() * 0.01) * 0.3;
                        });
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(talkInterval);
                        // Reset rotazioni
                        mouthBones.forEach((bone, index) => {
                            bone.rotation.x = originalRotations[index];
                        });
                        isTalking = false;
                    }, duration);
                }
                
                // Metodo 3: Movimento testa come fallback
                else {
                    const originalY = character3D.rotation.y;
                    const talkInterval = setInterval(() => {
                        character3D.rotation.y = originalY + Math.sin(Date.now() * 0.02) * 0.1;
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(talkInterval);
                        character3D.rotation.y = originalY;
                        isTalking = false;
                    }, duration);
                }
            } else {
                // Fallback se personaggio non caricato
                setTimeout(() => {
                    isTalking = false;
                }, duration);
            }
        }

        function speakText(text) {
            if (!speechSynthesis) return;
            
            speechSynthesis.cancel();
            
            // Rimuove emoji per pronuncia più chiara
            const cleanText = text.replace(/[🌾🫒🐑🌍👨‍👩‍👧‍👦❤️👵🌤️😅✨👋😊🛒🕐💰⭐📍🤔💡🎯✅🗺️💬🔊🎤❌⚠️🔴]/g, '');
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.voice = currentVoice;
            utterance.volume = document.getElementById('volumeSlider').value / 100;
            utterance.rate = 0.75; // Più lento e riflessivo
            utterance.pitch = 0.85; // Più grave, come un anziano saggio
            
            utterance.onstart = function() {
                updateVoiceStatus("🗣️ Nonno Andrea ti sta raccontando...");
            };
            
            utterance.onend = function() {
                updateVoiceStatus("🎤 Parla con nonno Andrea cliccando il microfono");
            };
            
            speechSynthesis.speak(utterance);
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            makeCharacterTalk(2000);
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function addMessage(text, isUser = false) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (isUser) {
                messageDiv.textContent = text;
                messages.appendChild(messageDiv);
            } else {
                messages.appendChild(messageDiv);
                typeWriter(messageDiv, text, 35);
                makeCharacterTalk(text.length * 70);
                
                setTimeout(() => {
                    speakText(text);
                }, 1000);
            }
            
            messages.scrollTop = messages.scrollHeight;
        }

        function typeWriter(element, text, speed = 50) {
            let i = 0;
            element.textContent = '';
            
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const userText = input.value.trim();
            
            if (!userText) return;
            
            addMessage(userText, true);
            input.value = '';
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                const response = generateResponse(userText);
                addMessage(response);
            }, 1800 + Math.random() * 1200);
        }

        function generateResponse(userText) {
            const text = userText.toLowerCase();
            
            // Saluti
            if (text.includes('ciao') || text.includes('buongiorno') || text.includes('salve') || text.includes('buonasera')) {
                return "👋 Ciao caro! Che piacere sentire una voce giovane e curiosa! Dimmi tutto, cosa ti piacerebbe sapere della mia vita in campagna?";
            }
            
            if (text.includes('sì') || text.includes('si') || text.includes('volentieri') || text.includes('dimmi') || text.includes('racconta')) {
                return responses.azienda;
            }
            
            // Temi specifici con più variazioni
            if (text.includes('olio') || text.includes('olive') || text.includes('frantoio')) return responses.olio;
            if (text.includes('pecore') || text.includes('formaggio') || text.includes('pecorino') || text.includes('latte')) return responses.pecore;
            if (text.includes('terra') || text.includes('biologico') || text.includes('naturale') || text.includes('pesticidi')) return responses.terra;
            if (text.includes('famiglia') || text.includes('moglie') || text.includes('figli') || text.includes('maria')) return responses.famiglia;
            if (text.includes('passione') || text.includes('amore') || text.includes('piace') || text.includes('gioia')) return responses.passione;
            if (text.includes('ricette') || text.includes('cucinare') || text.includes('mangiare') || text.includes('nonna')) return responses.ricette;
            if (text.includes('stagioni') || text.includes('tempo') || text.includes('clima') || text.includes('primavera')) return responses.stagioni;
            if (text.includes('difficoltà') || text.includes('problemi') || text.includes('fatica') || text.includes('duro')) return responses.difficolta;
            if (text.includes('sogni') || text.includes('futuro') || text.includes('speranza') || text.includes('giovani')) return responses.sogni;
            if (text.includes('azienda') || text.includes('storia') || text.includes('iniziato') || text.includes('generazioni')) return responses.azienda;
            
            // Risposte più personali
            if (text.includes('età') || text.includes('anni') || text.includes('vecchio')) {
                return "😊 Ho 70 anni compiuti, ma mi sento come se ne avessi 40! Il lavoro nei campi mantiene giovani il corpo e l'anima, sai. E poi, finché queste vecchie mani reggono e il cuore batte forte, io continuo con passione!";
            }
            
            if (text.includes('grazie') || text.includes('bello') || text.includes('interessante')) {
                return "🥰 Ma grazie a te, caro figliolo! È bello vedere che ci sono ancora persone giovani interessate alla vera tradizione contadina. Mi scalda proprio il cuore parlare con te!";
            }
            
            if (text.includes('dove') || text.includes('posizione') || text.includes('umbria')) {
                return "📍 La mia azienda è qui in Umbria, sui dolci colli tra Perugia e Assisi. Un posto benedetto dal Signore, con una vista mozzafiato che non ti stancheresti mai di guardare. Se un giorno passi di qua, fermati a trovarmi!";
            }
            
            if (text.includes('consigli') || text.includes('saggezza') || text.includes('imparare')) {
                return "💡 Il mio consiglio più prezioso? Abbiate pazienza e rispetto per i tempi della natura. La terra non ha fretta come noi uomini moderni. E ricordate sempre: le mani sporche di terra sono le più pulite e oneste del mondo!";
            }
            
            if (text.includes('prodotti') || text.includes('vendere') || text.includes('comprare')) {
                return "🛒 I miei prodotti li trovi proprio qui nel distributore! Olio extravergine, pecorino stagionato e miele di acacia. Tutto fatto con le mie mani e tanto amore. Provare per credere, come si dice!";
            }
            
            // Risposte di default più calorose
            const defaultResponses = [
                "🤔 Interessante quello che mi dici... dimmi di più! Mi piace sentire cosa pensa la gente giovane come te.",
                "😊 Ah sì? E tu cosa fai nella vita? Ti piacerebbe conoscere i segreti della vita di campagna?",
                "🌾 Che bello parlare con te! Hai mai assaggiato prodotti genuini fatti con le mani? Quelli che sanno ancora di una volta?",
                "👴 Raccontami un po' di te, caro! Io sono sempre curioso di sentire le storie delle persone che incontro...",
                "🌱 Sai, mi fa piacere che tu sia interessato. Oggi i giovani sono sempre di fretta, ma tu sembri diverso!"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            initSpeechRecognition();
            init3DCharacter(); // Carica personaggio 3D
            // addDebugControls(); // Decommentare per controlli mouse
            
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = initVoices;
            } else {
                initVoices();
            }
        });

        if (document.readyState !== 'loading') {
            initSpeechRecognition();
            init3DCharacter(); // Carica personaggio 3D
            // addDebugControls(); // Decommentare per controlli mouse
            initVoices();
        }

        // Animazione iniziale del personaggio (quando è caricato)
        setTimeout(() => {
            if (isCharacterLoaded) {
                makeCharacterTalk(4000);
            }
        }, 3000);
    </script>
</body>
</html>

